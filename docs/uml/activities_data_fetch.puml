@startuml
title データフェッチ処理 アクティビティ図

start

:設定読み込み\n(取引所名, シンボル, 期間);

if (既存データの\n有無を確認？) then (あり)
  :最新取得済み日時を\n取得;
else (なし)
  :初回取得として\n全期間を対象に設定;
endif

:フェッチ対象期間を\n決定;

repeat
  :外部取引所API呼び出し\n(ccxt 等);
  if (API応答は正常？) then (はい)
    :取得OHLCVを検証\n(欠損・順序チェック);
    :パーケット or DB形式に\n変換;
    :ローカルストア\n(parquet / sqlite / duckdb)へ保存;
  else (いいえ)
    :リトライ回数を\nカウントアップ;
    if (最大リトライ回数超過？) then (はい)
      :エラーをログ出力;
      stop
    else (いいえ)
      :待機して再試行;
    endif
  endif

  :次の時間枠に\nフェッチ対象を更新;
repeat while (未取得の期間が\n残っている？) is (はい)

:全期間のデータ取得完了をログ出力;

stop

@enduml

