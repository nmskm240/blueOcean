@startuml
title 本番稼働(リアルトレード) アクティビティ図

start

:リアルトレードジョブ要求を受付\n(戦略, 資金, 取引所, シンボル 等);

:APIキー・秘密鍵など\n認証情報を読み込み;
:取引所接続設定をロード\n(ccxt, CcxtBroker);

if (認証情報は有効？) then (有効)
  :CcxtBroker / CcxtSpotStore を初期化;
  :リアルタイム or ポーリング用\nデータフィードを設定;
  :backtrader Cerebro を初期化;
  :戦略(Strategy)を追加;
  :ブローカー設定(レバレッジ, 注文種別, 手数料)を適用;
else (無効)
  :認証エラーをログ出力;
  stop
endif

repeat
  :最新の市場データを取得\n(取引所API);
  :データをfeedに流し込み;

  :戦略ロジックを実行\n(cerebro.runonce / runnext);
  if (売買シグナル発生？) then (はい)
    :注文内容を生成\n(数量, 方向, 価格 等);
    :取引所へ注文送信\n(CcxtBroker);
    if (注文結果は成功？) then (成功)
      :約定情報を更新\n(ポジション, 残高);
      :取引履歴を永続化\n(DB / ログ);
    else (失敗)
      :エラー内容をログ出力;
      if (致命的なエラー？) then (はい)
        :リスク管理のため\n戦略を停止;
        break
      endif
    endif
  endif

  :リスク・ポジション管理を評価\n(ロスカット, 利確条件 等);
  if (停止条件を満たす？\n(時間, DD, 手動停止)) then (はい)
    break
  endif

repeat while (戦略が有効) is (継続)

:オープンポジションの有無を確認;
if (未クローズのポジションあり？) then (はい)
  :必要に応じてクローズ注文発行;
  :最終残高・ポジションを記録;
endif

:稼働結果をサマリ出力\n(損益, 取引回数, ログパス 等);

stop

@enduml

